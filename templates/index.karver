<html>
  <head>
    <link rel="stylesheet" type="text/css" href="assets/style.css">
    <link rel="stylesheet" type="text/css" href="assets/codemirror.css">
    
    <script src="assets/jquery-1.11.3.min.js"></script>
    <script src="assets/promise.min.js"></script>
    <script src="assets/codemirror.js"></script>

    <script type="text/javascript">
      $(function() {
        var $erdText = $("#erdText");
        var erdText = $erdText[0];

        var editor = CodeMirror.fromTextArea(erdText, {
          lineNumbers: true
        });

        var generateDiagram = function() {
          var erCode = editor.getValue();

          console.log('Generating diagram for:', erCode);

          promise.post('/generate', erCode)
            .then(function(error, text, xhr) {
               if (error) {
                   console.error('Error', xhr.status);
                   return;
               }

               try {
                if (text) {
                  text = text.replace(/\n/g, '\\n');
                }
                var data = JSON.parse(text);

                console.log('Response:', data);
               } catch (e) {
                 console.error('Error', e, '\nJSON:', text);

                 var data = { error: e };
               }

               if (data && data.image) {
                  $('#generatedImage').attr('src', data.image);
                  $('#status').html('Success!');
               } else {
                  $('#status').html('<pre>ERROR: ' + data.error + '</pre>');
               }
            });
        };

        var loadSample = function() {
          var sampleURL = new URL(this.href || document.location).hash.substring(1);

          console.log("Loading sample:", sampleURL);

          $erdText.load(sampleURL, function() {
            editor.setValue($erdText.text());

            generateDiagram();
          });
        };

        //Generate diagram for any ER text POSTed to the page (via erdText parameter or body of POST)
        if ($erdText.text()) {
          generateDiagram();
        }

        //Load any ER text from external URL passed as a #hash component of the URL
        if (document.location.hash) {
          loadSample();
        }

        $("#generateLink").on('click', generateDiagram);
        $('.formatSample').on('click', loadSample);
      });
    </script>
  </head>

  <body>
    <div class="header">
      <h1>ERD Web Server</h1>
      <h2>Generating Entity-Relationship Diagrams from Text</h2>
      <span id="status">Generate something!</span>
    </div>

    <div class="main">
      <div class="editorArea">
        <form method="post">
          <textarea id="erdText" name="erdText">{{erdText}}</textarea>
        </form>

        <div class="footer">
          <a id="generateLink" href="#">Generate Diagram</a>

          <p>Uses <a class="formatHelp" target="_blank" href="https://github.com/BurntSushi/erd#quick-example">ER format</a>.</p>
          <p>
            <a class="formatSample" href="#https://raw.githubusercontent.com/BurntSushi/erd/master/examples/simple.er">Simple sample</a>
            |
            <a class="formatSample" href="#https://raw.githubusercontent.com/BurntSushi/erd/master/examples/nfldb.er">Complex sample</a>
          </p>
        </div>
      </div>

      <div class="diagramArea">
        <img id="generatedImage" />
      </div>
    </div>

    <div class="footer">
      Based on the work by 
      <a target="_blank" href="http://tomassetti.me/an-erd-web-server-generation-entity-diagrams-from-a-textual-description-with-haskell/">Federico Tomassetti</a>.
    </div>
  </body>
</html>